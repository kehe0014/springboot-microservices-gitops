name: GitOps Sync

# Controls when the workflow will run
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  lint-helm:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.12.0'

      - name: Find and Lint All Helm Charts
        run: |
          find ./charts -type f -name "Chart.yaml" -print0 | while IFS= read -r -d '' chart_file; do
            chart_dir=$(dirname "$chart_file")
            echo "Linting chart in directory: $chart_dir"
            helm lint "$chart_dir" || { echo "âŒ Chart $chart_dir failed linting"; exit 1; }
            echo "âœ… Chart $chart_dir linted successfully"
          done

  deploy-dev:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: 
      - lint-helm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.1.0'
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.0'

      - name: Decode Kubeconfig Secret
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.K8S_CONFIG_BASE64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify Cluster Access
        run: kubectl cluster-info

      - name: Deploy with Kustomize
        run: |
          set -e
          echo "ðŸ”§ Building manifests with Kustomize..."
          manifests=$(kustomize build ./k8s/kustomize/environments/dev/)
          
          if [ -z "$manifests" ]; then
            echo "âš ï¸ No manifests were generated by Kustomize. Skipping deployment."
            exit 0
          fi
          
          echo "$manifests" | kubectl apply --prune -f - --selector=app.kubernetes.io/managed-by=gitops-ci
          echo "âœ… Deployment applied successfully"
          
  verify-deployment:
    name: Verify Deployment Status
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: 
      - deploy-dev
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.0'
      
      - name: Decode Kubeconfig Secret
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.K8S_CONFIG_BASE64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Wait for Deployments to be Ready
        uses: sergeymind/k8s-wait-action@v1
        with:
          namespace: dev-microservices
          timeout: '300s'

      - name: Verify Final Status
        run: |
          echo "ðŸŽ‰ All deployments are ready and running!"
          echo "Summary of resources in dev-microservices namespace:"
          kubectl get all -n dev-microservices