name: GitOps Sync
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
lint-helm:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    
    - name: Set up chart-testing
      uses: helm/chart-testing-action@v2.4.0

    - name: Lint Helm Charts
      run: ct lint --charts ./charts

    - name: Install Cosign
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: 'v2.4.0'
  deploy-dev:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: lint-helm
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.1.0'
      
      - name: Deploy to Dev
        run: |
          kubectl config set-cluster demo-cluster --server=${{ secrets.K8S_DEV_SERVER }}
          kubectl config set-credentials gitops-user --token=${{ secrets.K8S_DEV_TOKEN }}
          kubectl config set-context demo-context --cluster=demo-cluster --user=gitops-user
          kubectl config use-context demo-context
          
          kustomize build ./k8s/kustomize/environments/dev/ | kubectl apply -f -
