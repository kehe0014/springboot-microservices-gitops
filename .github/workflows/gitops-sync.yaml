name: GitOps Sync

# Controls when the workflow will run
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Defines a single reusable job for Kubernetes cluster access
jobs:
  configure-k8s:
    name: Configure Kubernetes Access
    runs-on: ubuntu-latest
    steps:
      - name: Configure kubectl with Base64 Secret
        id: configure-kubectl
        uses: sergeymind/k8s-configure-action@v1
        with:
          k8s_cluster_config: ${{ secrets.K8S_CONFIG_BASE64 }}
          k8s_version: 'v1.27.0'

# A job to lint Helm charts for quality control
  lint-helm:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.12.0'

      - name: Find and Lint All Helm Charts
        run: |
          # Use a more robust 'while' loop to handle paths with spaces
          find ./charts -type f -name "Chart.yaml" -print0 | while IFS= read -r -d '' chart_file; do
            chart_dir=$(dirname "$chart_file")
            echo "Linting chart in directory: $chart_dir"
            helm lint "$chart_dir" || { echo "‚ùå Chart $chart_dir failed linting"; exit 1; }
            echo "‚úÖ Chart $chart_dir linted successfully"
          done

# A job to deploy to the dev environment
  deploy-dev:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: 
      - lint-helm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.1.0'

      - name: Configure Kubernetes Access
        uses: sergeymind/k8s-configure-action@v1
        with:
          k8s_cluster_config: ${{ secrets.K8S_CONFIG_BASE64 }}
          k8s_version: 'v1.27.0'

      - name: Verify Cluster Access
        run: kubectl cluster-info

      - name: Deploy with Kustomize
        run: |
          kustomize build ./k8s/kustomize/environments/dev/ | kubectl apply --prune -f -

# A job to verify the deployment's status
  verify-deployment:
    name: Verify Deployment Status
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: 
      - deploy-dev
    steps:
      - name: Configure Kubernetes Access
        uses: sergeymind/k8s-configure-action@v1
        with:
          k8s_cluster_config: ${{ secrets.K8S_CONFIG_BASE64 }}
          k8s_version: 'v1.27.0'

      - name: Wait for Deployments to be Ready
        uses: sergeymind/k8s-wait-action@v1
        with:
          namespace: dev-microservices
          timeout: '300s'

      - name: Verify Final Status
        run: |
          echo "üéâ All deployments are ready and running!"
          echo "Summary of resources in dev-microservices namespace:"
          kubectl get all -n dev-microservices