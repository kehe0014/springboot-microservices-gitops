name: GitOps Sync
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual triggering

jobs:
  lint-helm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.12.0'
      
      - name: Find and lint all Helm charts
        run: |
          # Find all Chart.yaml files and get their directory paths
          find ./charts -name "Chart.yaml" | while read chart_file; do
            chart_dir=$(dirname "$chart_file")
            echo "Linting chart in directory: $chart_dir"
            helm lint "$chart_dir"
            if [ $? -eq 0 ]; then
              echo "✅ Chart $chart_dir linted successfully"
            else
              echo "❌ Chart $chart_dir failed linting"
              exit 1
            fi
          done
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.4.0'

  deploy-dev:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: lint-helm
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.1.0'
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.0'
      
      - name: Deploy to Dev
        run: |
          kubectl config set-cluster demo-cluster --server=${{ secrets.K8S_DEV_SERVER }} --insecure-skip-tls-verify=true
          kubectl config set-credentials gitops-user --token=${{ secrets.K8S_DEV_TOKEN }}
          kubectl config set-context demo-context --cluster=demo-cluster --user=gitops-user
          kubectl config use-context demo-context
          
          kustomize build ./k8s/kustomize/environments/dev/ | kubectl apply -f -